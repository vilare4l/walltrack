# =============================================================================
# WallTrack - Docker Compose Override for LocalAI Stack Integration
# =============================================================================
#
# This file connects WallTrack to the external localai network
# where shared infrastructure services are running:
#   - Neo4j (neo4j-walltrack) - Graph database for clusters
#   - PostgreSQL (supabase-db) - Direct DB access
#   - Supabase API (supabase-kong) - REST API on port 8000
#   - Redis (redis) - Optional job queue
#   - MinIO (localai-minio-1) - Optional S3 storage
#
# Usage:
#   docker compose -f docker-compose.yml -f docker-compose.override.yml up -d
#
# Prerequisites:
#   The localai stack must be running:
#   cd ../localai && docker compose up -d
# =============================================================================

services:
  # ========================================
  # WallTrack Main Application - Network Override
  # ========================================
  walltrack:
    networks:
      - walltrack_network
      - localai    # Connect to shared infrastructure

    environment:
      # Neo4j - use dedicated WallTrack Neo4j container
      - NEO4J_URI=bolt://neo4j-walltrack:7687
      - NEO4J_USER=neo4j
      - NEO4J_PASSWORD=walltrackpass
      - NEO4J_DATABASE=neo4j

      # Supabase REST API - via Kong gateway
      - SUPABASE_URL=http://supabase-kong:8000
      # PostgreSQL direct - via supabase-db container
      - DATABASE_URL=postgresql://postgres:postgres@supabase-db:5432/postgres
      - POSTGRES_SCHEMA=walltrack

      # Redis - use container name (internal port 6379)
      - REDIS_HOST=redis
      - REDIS_PORT=6379

      # MinIO - use container name (internal port 9000)
      - STORAGE_ENDPOINT=http://localai-minio-1:9000
      - STORAGE_PUBLIC_ENDPOINT=http://localhost:9010

  # ========================================
  # WallTrack Dashboard - Network Override
  # ========================================
  walltrack-dashboard:
    networks:
      - walltrack_network
      - localai    # Connect to shared infrastructure

    environment:
      # API URL for dashboard to call health checks
      - API_BASE_URL=http://walltrack-app:8000

      # Neo4j - use dedicated WallTrack Neo4j container
      - NEO4J_URI=bolt://neo4j-walltrack:7687
      - NEO4J_USER=neo4j
      - NEO4J_PASSWORD=walltrackpass
      - NEO4J_DATABASE=neo4j

      # Supabase REST API - via Kong gateway
      - SUPABASE_URL=http://supabase-kong:8000
      # PostgreSQL direct - via supabase-db container
      - DATABASE_URL=postgresql://postgres:postgres@supabase-db:5432/postgres
      - POSTGRES_SCHEMA=walltrack

      # Redis - use container name
      - REDIS_HOST=redis
      - REDIS_PORT=6379

  # ========================================
  # Position Monitor - Network Override
  # ========================================
  walltrack-monitor:
    networks:
      - walltrack_network
      - localai    # Connect to shared infrastructure

    environment:
      # Neo4j - use dedicated WallTrack Neo4j container
      - NEO4J_URI=bolt://neo4j-walltrack:7687
      - NEO4J_USER=neo4j
      - NEO4J_PASSWORD=walltrackpass
      - NEO4J_DATABASE=neo4j

      # Supabase REST API - via Kong gateway
      - SUPABASE_URL=http://supabase-kong:8000
      # PostgreSQL direct - via supabase-db container
      - DATABASE_URL=postgresql://postgres:postgres@supabase-db:5432/postgres
      - POSTGRES_SCHEMA=walltrack

      # Redis - use container name
      - REDIS_HOST=redis
      - REDIS_PORT=6379

# ========================================
# External Network Declaration
# ========================================
networks:
  localai:
    external: true
    name: localai
