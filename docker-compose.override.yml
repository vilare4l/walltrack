# =============================================================================
# WallTrack - Docker Compose Override for LocalAI Stack Integration
# =============================================================================
#
# This file connects WallTrack to the external localai_default network
# where shared infrastructure services are running:
#   - Neo4j (localai-neo4j-1) - Graph database for clusters
#   - PostgreSQL (localai-postgres-1) - Via Supabase for transactional data
#   - Redis (localai-redis-1) - Optional job queue
#   - MinIO (localai-minio-1) - Optional S3 storage
#
# Usage:
#   docker compose -f docker-compose.yml -f docker-compose.override.yml up -d
#
# Prerequisites:
#   The localai stack must be running:
#   cd ../localai && docker compose up -d
# =============================================================================

services:
  # ========================================
  # WallTrack Main Application - Network Override
  # ========================================
  walltrack:
    networks:
      - walltrack_network
      - localai_default    # Connect to shared infrastructure

    environment:
      # Neo4j - use container name (internal port 7687)
      - NEO4J_URI=bolt://localai-neo4j-1:7687
      - NEO4J_USER=neo4j
      - NEO4J_PASSWORD=neo4jpass
      # Dedicated Neo4j database for WallTrack
      - NEO4J_DATABASE=walltrack

      # PostgreSQL/Supabase - use container name
      # Port 5432 for direct connection, or use Supabase API
      - DATABASE_URL=postgresql://postgres:postgres@localai-postgres-1:5432/postgres
      # Dedicated PostgreSQL schema for WallTrack
      - POSTGRES_SCHEMA=walltrack

      # Redis - use container name (internal port 6379)
      - REDIS_HOST=localai-redis-1
      - REDIS_PORT=6379

      # MinIO - use container name (internal port 9000)
      - STORAGE_ENDPOINT=http://localai-minio-1:9000
      # Public endpoint for URL generation (external access)
      - STORAGE_PUBLIC_ENDPOINT=http://localhost:9010

  # ========================================
  # Position Monitor - Network Override
  # ========================================
  walltrack-monitor:
    networks:
      - walltrack_network
      - localai_default    # Connect to shared infrastructure

    environment:
      # Neo4j - use container name
      - NEO4J_URI=bolt://localai-neo4j-1:7687
      - NEO4J_USER=neo4j
      - NEO4J_PASSWORD=neo4jpass
      # Dedicated Neo4j database for WallTrack
      - NEO4J_DATABASE=walltrack

      # PostgreSQL - use container name
      - DATABASE_URL=postgresql://postgres:postgres@localai-postgres-1:5432/postgres
      # Dedicated PostgreSQL schema for WallTrack
      - POSTGRES_SCHEMA=walltrack

      # Redis - use container name
      - REDIS_HOST=localai-redis-1
      - REDIS_PORT=6379

# ========================================
# External Network Declaration
# ========================================
networks:
  localai_default:
    external: true
    name: localai_default
