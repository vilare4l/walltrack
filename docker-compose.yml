# =============================================================================
# WallTrack - Docker Compose Configuration
# =============================================================================
#
# Usage:
#   Development (standalone):  docker compose up -d
#   With localai stack:        docker compose -f docker-compose.yml -f docker-compose.override.yml up -d
#
# The override file connects to the external localai_default network
# where Neo4j, PostgreSQL, Redis, and MinIO are running.
# =============================================================================

services:
  # ========================================
  # WallTrack API (FastAPI)
  # ========================================
  walltrack:
    build:
      context: .
      dockerfile: Dockerfile

    container_name: walltrack-app

    ports:
      - "${PORT:-8080}:8000"      # FastAPI API

    env_file: .env

    environment:
      - PYTHONPATH=/app/src
      - PYTHONUNBUFFERED=1
      # Discovery Scheduler
      - DISCOVERY_SCHEDULER_ENABLED=${DISCOVERY_SCHEDULER_ENABLED:-true}
      - DISCOVERY_SCHEDULE_HOURS=${DISCOVERY_SCHEDULE_HOURS:-6}

    volumes:
      # Development: mount source for hot reload
      - ./src:/app/src:ro
      # Persist logs
      - walltrack_logs:/app/logs

    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8000/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s

    restart: unless-stopped

    networks:
      - walltrack_network

  # ========================================
  # WallTrack Dashboard (Gradio)
  # ========================================
  walltrack-dashboard:
    build:
      context: .
      dockerfile: Dockerfile

    container_name: walltrack-dashboard

    command: ["uv", "run", "python", "-c", "from walltrack.ui.dashboard import launch_dashboard; launch_dashboard()"]

    ports:
      - "${UI_PORT:-7865}:7860"   # Gradio Dashboard

    env_file: .env

    environment:
      - PYTHONPATH=/app/src
      - PYTHONUNBUFFERED=1
      # Dashboard connects to API container via internal Docker network
      - API_BASE_URL=http://walltrack-app:8000

    volumes:
      - ./src:/app/src:ro
      - walltrack_logs:/app/logs

    # Dashboard health check on Gradio port
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:7860/"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 60s

    depends_on:
      walltrack:
        condition: service_healthy

    restart: unless-stopped

    networks:
      - walltrack_network

  # ========================================
  # Webhook Receiver (Optional - for ngrok/cloudflare tunnel)
  # ========================================
  # Uncomment if you need a separate webhook service
  #
  # walltrack-webhook:
  #   build:
  #     context: .
  #     dockerfile: Dockerfile
  #
  #   container_name: walltrack-webhook
  #
  #   command: ["uvicorn", "walltrack.api.app:create_webhook_app", "--host", "0.0.0.0", "--port", "8001"]
  #
  #   ports:
  #     - "8001:8001"
  #
  #   env_file: .env
  #
  #   restart: unless-stopped
  #
  #   networks:
  #     - walltrack_network

  # ========================================
  # Position Monitor (Background Worker)
  # ========================================
  walltrack-monitor:
    build:
      context: .
      dockerfile: Dockerfile

    container_name: walltrack-monitor

    command: ["uv", "run", "python", "-m", "walltrack.scheduler.jobs"]

    env_file: .env

    environment:
      - PYTHONPATH=/app/src
      - PYTHONUNBUFFERED=1

    volumes:
      - ./src:/app/src:ro
      - walltrack_logs:/app/logs

    # Disable health check for background worker (no HTTP server)
    healthcheck:
      disable: true

    depends_on:
      walltrack:
        condition: service_healthy

    restart: unless-stopped

    networks:
      - walltrack_network

# ========================================
# Volumes
# ========================================
volumes:
  walltrack_logs:
    name: walltrack_logs

# ========================================
# Networks
# ========================================
networks:
  walltrack_network:
    name: walltrack_network
    driver: bridge
