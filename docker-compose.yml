# =============================================================================
# WallTrack - Docker Compose Configuration
# =============================================================================
#
# Usage:
#   Development (standalone):  docker compose up -d
#   With localai stack:        docker compose -f docker-compose.yml -f docker-compose.override.yml up -d
#
# The override file connects to the external localai_default network
# where Neo4j, PostgreSQL, Redis, and MinIO are running.
# =============================================================================

services:
  # ========================================
  # WallTrack API (FastAPI)
  # ========================================
  walltrack:
    build:
      context: .
      dockerfile: Dockerfile

    container_name: walltrack-app

    ports:
      - "${PORT:-8080}:8000"      # FastAPI API + Gradio Dashboard at /dashboard
      # Note: For E2E tests, set BASE_URL=http://localhost:8080/dashboard

    env_file: .env

    environment:
      - PYTHONPATH=/app/src
      - PYTHONUNBUFFERED=1
      # ===================================
      # Discovery Scheduler Configuration
      # ===================================
      # DISCOVERY_SCHEDULER_ENABLED: Enable/disable auto discovery
      #   - true: Scheduler starts with app and runs token discovery automatically
      #   - false: Manual discovery only (useful for testing/CI)
      - DISCOVERY_SCHEDULER_ENABLED=${DISCOVERY_SCHEDULER_ENABLED:-true}
      # DISCOVERY_SCHEDULE_HOURS: Interval between discovery runs (1, 2, 4, 8 hours)
      #   - Default: 4 hours (recommended for production)
      #   - Lower values increase API calls but fresher data
      - DISCOVERY_SCHEDULE_HOURS=${DISCOVERY_SCHEDULE_HOURS:-4}

    volumes:
      # Development: mount source for hot reload
      - ./src:/app/src:ro
      # Persist logs
      - walltrack_logs:/app/logs

    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8000/api/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s

    restart: unless-stopped

    networks:
      - walltrack_network

  # ========================================
  # NOTE: Gradio Dashboard is mounted on FastAPI at /dashboard
  # No separate dashboard service needed in V2
  # Access dashboard at: http://localhost:8000/dashboard
  # ========================================

  # ========================================
  # Webhook Receiver (Optional - for ngrok/cloudflare tunnel)
  # ========================================
  # Uncomment if you need a separate webhook service
  #
  # walltrack-webhook:
  #   build:
  #     context: .
  #     dockerfile: Dockerfile
  #
  #   container_name: walltrack-webhook
  #
  #   command: ["uvicorn", "walltrack.api.app:create_webhook_app", "--host", "0.0.0.0", "--port", "8001"]
  #
  #   ports:
  #     - "8001:8001"
  #
  #   env_file: .env
  #
  #   restart: unless-stopped
  #
  #   networks:
  #     - walltrack_network

  # ========================================
  # Position Monitor (Background Worker)
  # ========================================
  # NOTE: Commented out for V2 - scheduler module not yet implemented
  # Will be enabled in Epic 6: Position & Order Management
  #
  # walltrack-monitor:
  #   build:
  #     context: .
  #     dockerfile: Dockerfile
  #
  #   container_name: walltrack-monitor
  #
  #   command: ["uv", "run", "python", "-m", "walltrack.scheduler.jobs"]
  #
  #   env_file: .env
  #
  #   environment:
  #     - PYTHONPATH=/app/src
  #     - PYTHONUNBUFFERED=1
  #
  #   volumes:
  #     - ./src:/app/src:ro
  #     - walltrack_logs:/app/logs
  #
  #   healthcheck:
  #     disable: true
  #
  #   depends_on:
  #     walltrack:
  #       condition: service_healthy
  #
  #   restart: unless-stopped
  #
  #   networks:
  #     - walltrack_network

# ========================================
# Volumes
# ========================================
volumes:
  walltrack_logs:
    name: walltrack_logs

# ========================================
# Networks
# ========================================
networks:
  walltrack_network:
    name: walltrack_network
    driver: bridge
